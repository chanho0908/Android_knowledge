# 안드로이드의 UI 동작

안드로이드의 UI 처리는 싱글 쓰레드 모델로 동작한다. 

즉, 메인 쓰레드가 아닌 다른 쓰레드에서 UI 를 업데이트하는 등의 행위를 하면 안된다. 따라서 메인 쓰레드를 UI 쓰레드라고 부르기도 한다.

## 왜 UI 는 싱글 쓰레드 모델로 동작할까?
이유는 간단하면서도 당연하다. 멀티 쓰레드 환경이라고 가정했을 때, 

여러 쓰레드에서 TextView 의 텍스트를 변경하는 상황이 발생하면 어떤 결과가 나타날 지 미지수이기 때문이다.

따라서 동작의 무결성을 보장하기 위해 타 쓰레드에서는 UI 를 건드릴 수 없고,

오로지 메인 쓰레드에서만 UI 관련 동작을 할 수 있게끔 하는 것이다.

### 이러한 싱글 쓰레드 모델에서 지켜야할 포인트들
>1. 메인 쓰레드 (UI 스레드) 를 블로킹해서는 안 된다.
>
>    메인 쓰레드를 블로킹한다는 뜻은, 사용자에게 보여지는 UI 동작을 멈춘다는 뜻이다. 
>    
>    메인 쓰레드가 블로킹되어 UI 동작이 멈추게 되면, 
>    
>    이는 표면적으로 앱 퍼포먼스 저하를 유발하게 되며 사용자 경험상 악영향을 끼친다. 
>    
>    따라서, 시간이 오래 걸리는 동작을 수행하는 등 메인 쓰레드를 블로킹해선 안 된다.
>    
>    <strong>UI 관련 동작은 오로지 메인 쓰레드에서만 접근해야 함</strong>


### 시간이 오래 걸리는 무거운 동작들은 따로 돌리자


즉, 무거운 동작들은 메인 쓰레드가 아닌 다른 쓰레드를 생성하여 수행해야 한다.

그런데, 쓰레드를 별도로 생성하여 시간이 오래 걸리는 동작들을 한다고 해도, 그 동작의 '결과' 는 보통 UI 를 업데이트하는 데에 사용된다.

![image](https://user-images.githubusercontent.com/84930748/230524048-6b63f2d9-e7ae-4c18-a8d0-47ffe94c5215.png)

>예를 들어 쓰레드를 새로 생성하여, 고양이 사진을 제공해주는 서버의 API 를 호출하여 고양이 사진을 받은 뒤 
>
>ImageView 에 보여주는 동작을 한다고 하자. 
>그런데 아까 별도의 쓰레드에선 UI 관련 동작을 해서는 안 된다고 했다. 
>
>그럼 결과로 받은 고양이 사진을 어떻게 사용자에게 보여줄 수 있을까?

가장 먼저 떠오르는 방법은, 다른 쓰레드에서 메인 쓰레드로 결과를 전송하는 방식이다. 즉, 쓰레드간의 통신을 구현하는 것이다.

안드로이드에선 쓰레드간의 통신을 위해, Looper 와 Handler 라는 장치를 제공해준다. 

이 녀석들을 활용하여 효율적으로 멀티 쓰레딩 환경을 구축할 수 있다


# Looper

하나의 쓰레드에는 오직 하나의 Looper 를 가지며, Looper 는 오직 하나의 쓰레드를 담당한다. 

안드로이드에선 기본적으로 MainActivity 가 실행됨과 동시에 자동으로 메인 쓰레드의 Looper 가 돌기 시작한다.

각 쓰레드의 Looper 내부에는 MessageQueue 라는 것이 존재하는데, 여기에는 해당 쓰레드가 처리해야 할 동작들이 

'메세지' 라는 형태로 하나씩 쌓이게 된다. (큐 라는 이름에서 알 수 있듯 당연히 FIFO 방식이다)

Looper 는 궁극적으로, MessageQueue 에 들어오는 메세지들을 하나씩 꺼내어 이를 적절한 Handler 로 전달하는 역할을 한다.

기본적으로 Looper 는 자신이 어떤 Handler 에 메세지를 전달해야 하는지에 대한 참조를 갖고 있다. (기본값 : 메인 쓰레드의 Handler)

## 메세지
> Message 는 '하나의 작은 작업 단위' 라고 생각하면 편하다. MessageQueue 에는 이러한 작은 작업 단위를 하나씩 적재해두고, 
> Looper 가 이를 차례대로 처리하는 것이다. Message 객체는 내용물이 두 가지 종류로 이루어진다. 
> Runnable 객체로 이루어져있을 수도 있고, 일반적인 경우 Message 객체로 이루어져있을 수도 있다. 
> 
> Looper 객체가 메세지 큐에서 메세지를 하나 딱 까봤을 때, Runnable 객체가 담겨져있으면 Handler 에 메세지를 전달하지 않고
> 
> run() 을 수행하여 해당 Runnble 작업을 바로 시작하고, Runnable 객체가 없을 경우 Message 객체 내부에 명시 되어있는 
> 
> Handler 의 handleMessage() 를 수행하여 처리한다.

## Handler

특정 메세지를 Looper 의 MessageQueue 에 넣거나, Looper 가 MessageQueue 에서 특정 메세지를 

꺼내어 전달하면 이를 처리하는 기능을 수행

### Looper 로 메세지를 전달하는 경우
Message 객체를 생성하여 이를 전달하는 방식으로 구현한다.

- sendMessage() 메소드를 통해 메세지 큐에 Message 객체를 적재할 수 있다.
- post 로 시작하는 메소드들을 통해 Runnable 객체를 직접 적재할 수 있다.

### Looper 로부터 메세지를 전달받는 경우
Looper 가 메세지 큐에서 메세지 하나를 딱 꺼냈을 때,

- Runnable 객체가 담겨있다면
   → 해당 Runnable 의 run() 메소드를 호출하여 작업을 실행할 수 있다.

- Message 객체가 담겨있다면
   → 해당 메세지 내부의 Handler 가 갖고 있는 handleMessage() 메소드를 호출함으로써 해당 
   
    Handler 가 메세지를 전달받을 수 있다
    

